import pandas as pd
import numpy as np
import matplotlib.pyplot as plt
from sklearn.ensemble import RandomForestRegressor
from tqdm import tqdm
import warnings
import os

# ==========================================
# 0. ç¯å¢ƒä¸ç”»å›¾é…ç½® (å‡ºç‰ˆçº§è®¾ç½®)
# ==========================================
warnings.filterwarnings("ignore")

# --- å­—ä½“ä¸æ ·å¼è®¾ç½® ---
# è®¾ç½®ä¸º Times New Roman
plt.rcParams['font.family'] = 'serif'
plt.rcParams['font.serif'] = ['Times New Roman']
# è§£å†³è´Ÿå·æ˜¾ç¤ºé—®é¢˜
plt.rcParams['axes.unicode_minus'] = False 
# è®¾ç½®åŸºç¡€å­—å·
plt.rcParams['font.size'] = 14 

# å‚æ•°è®¾ç½®
PATH = r"C:\Users\Administrator\GWRF"
FILE_NAME = "train_data_0610.xlsx"
BANDWIDTH = 15000 
TARGET_COL = 'Y'
COORD_COLS = ['y_cordinat', 'x_cordinat']

FEATURE_COLS = [
    'SHDI', 'SHAPE', 'PD', 'CONTIG', 
    'DistFacility', 'DistWater', 'DistAccommodation', 'DistRoad', 
    'DistRestaurant', 'DistMountain', 'DistScenicSite', 'DistBusStop', 
    'Terrain relief', 'TRI', 'Annual NDVI', 'Elevation', 'Travel time'
]

# ==========================================
# 1. æ ¸å¿ƒè®¡ç®—å‡½æ•° (ä¿æŒä¸å˜)
# ==========================================
def calculate_weights(coords_train, target_point, bandwidth):
    lats = coords_train.iloc[:, 0].values
    lons = coords_train.iloc[:, 1].values
    t_lat, t_lon = target_point
    R = 6371000 
    dlat = np.radians(lats - t_lat)
    dlon = np.radians(lons - t_lon)
    a = np.sin(dlat/2)**2 + np.cos(np.radians(t_lat)) * np.cos(np.radians(lats)) * np.sin(dlon/2)**2
    c = 2 * np.arctan2(np.sqrt(a), np.sqrt(1-a))
    distances = R * c
    return np.exp(-0.5 * (distances / bandwidth) ** 2)

# ==========================================
# 2. å•ç‹¬ç»˜åˆ¶ç²¾ç¾æ¡å½¢å›¾çš„å‡½æ•°
# ==========================================
def save_high_res_bar_chart(roi_name, data_series, color, output_folder):
    """
    ç»˜åˆ¶å¹¶ä¿å­˜å•å¼ é«˜æ¸…æ¡å½¢å›¾
    """
    # åˆ›å»ºç‹¬ç«‹ç”»å¸ƒï¼Œæ¯”ä¾‹è®¾ç½®ä¸º 6:4ï¼Œé€‚åˆè®ºæ–‡æ’å›¾
    fig, ax = plt.subplots(figsize=(6, 4))
    
    # ç»˜åˆ¶æ°´å¹³æ¡å½¢å›¾
    y_pos = np.arange(len(data_series))
    bars = ax.barh(y_pos, data_series.values, color=color, alpha=0.85, height=0.6)
    
    # è®¾ç½® Y è½´æ ‡ç­¾
    ax.set_yticks(y_pos)
    ax.set_yticklabels(data_series.index, fontsize=14) # å­—ä½“å¤§ä¸€ç‚¹
    
    # X è½´è®¾ç½®
    ax.set_xlabel('Feature Importance', fontsize=14, fontweight='bold', labelpad=10)
    
    # --- ç¾åŒ–ç»†èŠ‚ ---
    # 1. å»é™¤ä¸Šè¾¹å’Œå³è¾¹çš„è¾¹æ¡†
    ax.spines['top'].set_visible(False)
    ax.spines['right'].set_visible(False)
    # 2. åŠ ç²—å·¦è¾¹å’Œåº•éƒ¨çš„è½´çº¿
    ax.spines['left'].set_linewidth(1.2)
    ax.spines['bottom'].set_linewidth(1.2)
    # 3. æ·»åŠ å‚ç›´è™šçº¿ç½‘æ ¼
    ax.grid(axis='x', linestyle='--', alpha=0.3)
    
    # åœ¨æŸ±å­æ—è¾¹æ ‡æ³¨æ•°å€¼
    max_val = data_series.max()
    ax.set_xlim(0, max_val * 1.25) # ç•™å‡ºå³ä¾§ç©ºé—´ç»™æ•°å­—
    
    for bar in bars:
        width = bar.get_width()
        ax.text(width + (max_val * 0.02), # ç¨å¾®åç§»ä¸€ç‚¹
                bar.get_y() + bar.get_height()/2, 
                f'{width:.3f}', 
                va='center', 
                fontsize=12,
                fontname='Times New Roman')

    # æ ‡é¢˜ (å¯é€‰ï¼Œæ—¢ç„¶ä½ è¦åæœŸæ’ç‰ˆï¼Œæ ‡é¢˜å¯ä»¥ä¸è¦ï¼Œè¿™é‡Œä¿ç•™ä½œä¸ºæ–‡ä»¶åŒºåˆ†)
    clean_name = roi_name.replace(" ", "_").replace("(", "").replace(")", "")
    # ax.set_title(roi_name, fontsize=16, fontweight='bold', pad=15) 
    
    plt.tight_layout()
    
    # ä¿å­˜ä¸º 1000 DPI
    save_name = f"{output_folder}\\BarChart_{clean_name}.png"
    plt.savefig(save_name, dpi=1000, bbox_inches='tight')
    plt.close(fig) # å…³é—­ç”»å¸ƒé‡Šæ”¾å†…å­˜
    print(f"ğŸ–¼ï¸ å·²ä¿å­˜é«˜æ¸…å›¾ç‰‡: {save_name}")

# ==========================================
# 3. ä¸»ç¨‹åº
# ==========================================
def run_export_viz():
    print("ğŸš€ å¼€å§‹è®¡ç®—å¹¶å¯¼å‡ºé«˜æ¸…å›¾è¡¨...")
    
    # 1. æ•°æ®åŠ è½½
    try:
        df = pd.read_excel(f"{PATH}\\{FILE_NAME}")
        df = df.reset_index(drop=True)
        print(f"âœ… æ•°æ®åŠ è½½æˆåŠŸ: {len(df)} æ ·æœ¬")
    except Exception as e:
        print(f"âŒ å¤±è´¥: {e}")
        return

    X = df[FEATURE_COLS]
    y = df[TARGET_COL]
    coords = df[COORD_COLS]

    # 2. è®­ç»ƒå…¨å±€æ¨¡å‹ (åŸºå‡†)
    print("â³ è®­ç»ƒå…¨å±€æ¨¡å‹...")
    grf = RandomForestRegressor(n_estimators=100, random_state=42, n_jobs=-1).fit(X, y)
    global_imp = grf.feature_importances_
    
    # 3. GWRF è®¡ç®— (åŒä¹‹å‰)
    local_imps = []
    print("â³ è®¡ç®—å±€éƒ¨é‡è¦æ€§ (è¯·ç¨å€™)...")
    
    for i in tqdm(range(len(X))):
        target_pt = (coords.iloc[i, 0], coords.iloc[i, 1])
        w = calculate_weights(coords, target_pt, BANDWIDTH)
        
        use_global = False
        if np.sum(w > 0.05) < 5:
            use_global = True
        else:
            try:
                lrf = RandomForestRegressor(n_estimators=20, max_depth=4, n_jobs=1, random_state=42)
                lrf.fit(X, y, sample_weight=w)
                imp = lrf.feature_importances_
                if np.sum(imp) < 1e-6: 
                    use_global = True
                else:
                    local_imps.append(imp)
            except:
                use_global = True
        
        if use_global:
            local_imps.append(global_imp)
    
    df_imp = pd.DataFrame(local_imps, columns=FEATURE_COLS, index=df.index)
    
    # ==============================================================================
    # 4. å®šä¹‰ ROI å¹¶å¯¼å‡ºå›¾ç‰‡
    # ==============================================================================
    roi_definitions = [
        # Region A
        {
            'label': 'Region A (Central)', 
            'center_lon': 103.70, 'center_lat': 25.60, 
            'width': 0.8, 'height': 0.8, 
            'color': '#F4A261' # æ©™è‰²
        },
        # Region B
        {
            'label': 'Region B (South)', 
            'center_lon': 104.35, 'center_lat': 25.00, 
            'width': 0.30, 'height': 0.30, 
            'color': '#2A9D8F' # é’è‰²
        }
    ]

    print("\nğŸ¨ å¼€å§‹ç»˜åˆ¶ç‹¬ç«‹é«˜æ¸…å›¾è¡¨...")
    
    for roi in roi_definitions:
        # ç­›é€‰åŒºåŸŸæ•°æ®
        lon_min = roi['center_lon'] - roi['width']/2
        lon_max = roi['center_lon'] + roi['width']/2
        lat_min = roi['center_lat'] - roi['height']/2
        lat_max = roi['center_lat'] + roi['height']/2
        
        mask = (df['x_cordinat'] >= lon_min) & (df['x_cordinat'] <= lon_max) & \
               (df['y_cordinat'] >= lat_min) & (df['y_cordinat'] <= lat_max)
        
        if mask.sum() > 0:
            subset_imp = df_imp.loc[mask]
            mean_imp = subset_imp.mean()
            
            # æ•°æ®æ ¡éªŒ
            if mean_imp.sum() < 1e-6:
                mean_imp = pd.Series(global_imp, index=FEATURE_COLS)
            
            # å– Top 5 å¹¶æ’åº (å‡åºï¼Œä¸ºäº†ç”»å›¾æ—¶æœ€å¤§çš„åœ¨æœ€ä¸Šé¢)
            top_5 = mean_imp.sort_values(ascending=True).tail(5)
            
            # è°ƒç”¨ç”»å›¾å‡½æ•°
            save_high_res_bar_chart(roi['label'], top_5, roi['color'], PATH)
            
        else:
            print(f"âš ï¸ åŒºåŸŸ {roi['label']} ä¸ºç©ºï¼Œè·³è¿‡ã€‚")

    print("\nâœ… æ‰€æœ‰å›¾ç‰‡å¯¼å‡ºå®Œæˆï¼è¯·æ£€æŸ¥æ–‡ä»¶å¤¹ã€‚")

if __name__ == "__main__":
    run_export_viz()
